version: '3.4'

services:
  app:
    build:
      context: ../../
      dockerfile: ./build/concept_miner_elastic/app/Dockerfile
    init: true
    volumes:
      # Update this to wherever you want VS Code to mount the folder of your project
      - ../../:/workspace:cached

    command: sleep infinity 
    networks:
      - elastic
      - web
    depends_on:
      - "elastic"

  web:
    image: nginx:latest
    ports:
      - 8000:8000
    volumes:
      - ../../conf/nginx.conf:/etc/nginx/nginx.conf:ro
      - ../../conf/htpasswd.users:/etc/nginx/htpasswd.users:ro
      - ../../app/web/static:/www/static:ro
    networks:
      - web

  elastic:
    image: docker.elastic.co/elasticsearch/elasticsearch:7.14.0
    volumes:
      - es-data:/usr/share/elasticsearch/data
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
    networks:
      - elastic


  kibana:
    image: docker.elastic.co/kibana/kibana:7.14.0
    volumes:
      - ../../conf/kibana.yml:/usr/share/kibana/config/kibana.yml
    environment:
      - ELASTICSEARCH_HOSTS=http://elastic:9200
      - SERVER_PUBLICBASEURL=${KIBANA_SERVER_PUBLICBASEURL}
    networks:
      - elastic
      - web

networks:
  elastic:
  web:
  
volumes:
  es-data:
    driver: local